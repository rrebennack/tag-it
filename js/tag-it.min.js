(function(a){a.widget('ui.tagit',{options:{allowDuplicates:!1,caseSensitive:!0,fieldName:'tags',placeholderText:null,readOnly:!1,removeConfirmation:!1,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:!1,allowSpaces:!1,singleField:!1,singleFieldDelimiter:',',singleFieldNode:null,animate:!0,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onTagClicked:null,onTagLimitExceeded:null},_create:function(){var b=this;this.element.is('input')?(this.tagList=a('<ul></ul>').insertAfter(this.element),this.options.singleField=!0,this.options.singleFieldNode=this.element,this.element.addClass('tagit-hidden-field')):this.tagList=this.element.find('ul, ol').addBack().last(),this.tagInput=a('<input type="text" />').addClass('ui-widget-content'),this.options.readOnly&&this.tagInput.attr('disabled','disabled'),this.options.tabIndex&&this.tagInput.attr('tabindex',this.options.tabIndex),this.options.placeholderText&&this.tagInput.attr('placeholder',this.options.placeholderText),this.options.autocomplete.source||(this.options.autocomplete.source=function(h,j){var k=h.term.toLowerCase(),l=a.grep(this.options.availableTags,function(m){return 0===m.toLowerCase().indexOf(k)});this.options.allowDuplicates||(l=this._subtractArray(l,this.assignedTags())),j(l)}),this.options.showAutocompleteOnFocus&&(this.tagInput.focus(function(){b._showAutocomplete()}),'undefined'==typeof this.options.autocomplete.minLength&&(this.options.autocomplete.minLength=0)),a.isFunction(this.options.autocomplete.source)&&(this.options.autocomplete.source=a.proxy(this.options.autocomplete.source,this)),this.tagList.addClass('tagit').addClass('ui-widget ui-widget-content ui-corner-all').append(a('<li class="tagit-new"></li>').append(this.tagInput)).click(function(h){var j=a(h.target);if(j.hasClass('tagit-label')){var k=j.closest('.tagit-choice');k.hasClass('removed')||b._trigger('onTagClicked',h,{tag:k,tagLabel:b.tagLabel(k)})}else b.tagInput.focus()});var c=!1;if(this.options.singleField)if(this.options.singleFieldNode){var d=a(this.options.singleFieldNode),f=d.val().split(this.options.singleFieldDelimiter);d.val(''),a.each(f,function(h,j){b.createTag(j,null,!0),c=!0})}else this.options.singleFieldNode=a('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />'),this.tagList.after(this.options.singleFieldNode);if(c||this.tagList.children('li').each(function(){a(this).hasClass('tagit-new')||(b.createTag(a(this).text(),a(this).attr('class'),!0),a(this).remove())}),this.tagInput.keydown(function(h){if(h.which==a.ui.keyCode.BACKSPACE&&''===b.tagInput.val()){var j=b._lastTag();!b.options.removeConfirmation||j.hasClass('remove')?b.removeTag(j):b.options.removeConfirmation&&j.addClass('remove ui-state-highlight')}else b.options.removeConfirmation&&b._lastTag().removeClass('remove ui-state-highlight');(h.which===a.ui.keyCode.ENTER||h.which===a.ui.keyCode.COMMA&&!1===h.shiftKey||h.which==a.ui.keyCode.TAB&&''!==b.tagInput.val()||h.which==a.ui.keyCode.SPACE&&!0!==b.options.allowSpaces&&('"'!=a.trim(b.tagInput.val()).replace(/^s*/,'').charAt(0)||'"'==a.trim(b.tagInput.val()).charAt(0)&&'"'==a.trim(b.tagInput.val()).charAt(a.trim(b.tagInput.val()).length-1)&&0!=a.trim(b.tagInput.val()).length-1))&&((h.which!==a.ui.keyCode.ENTER||''!==b.tagInput.val())&&h.preventDefault(),!(b.options.autocomplete.autoFocus&&b.tagInput.data('autocomplete-open'))&&(b.tagInput.autocomplete('close'),b._createMultipleTags()))}).blur(function(){if(b.tagInput.data('autocomplete-open')){var j=document.activeElement,k=b.tagInput.autocomplete('widget').get(0);if(a.contains(k,j))return}b._createMultipleTags()}).on('paste',function(){setTimeout(function(){b._createMultipleTags()},0)}),this.options.availableTags||this.options.autocomplete.source){var g={select:function(h,j){return b.createTag(j.item.value),!1}};a.extend(g,this.options.autocomplete),this.tagInput.autocomplete(g).on('autocompleteopen.tagit',function(){b.tagInput.data('autocomplete-open',!0)}).on('autocompleteclose.tagit',function(){b.tagInput.data('autocomplete-open',!1)}),this.tagInput.autocomplete('widget').addClass('tagit-autocomplete')}},destroy:function(){return a.Widget.prototype.destroy.call(this),this.element.off('.tagit'),this.tagList.off('.tagit'),this.tagInput.removeData('autocomplete-open'),this.tagList.removeClass(['tagit','ui-widget','ui-widget-content','ui-corner-all','tagit-hidden-field'].join(' ')),this.element.is('input')?(this.element.removeClass('tagit-hidden-field'),this.tagList.remove()):(this.element.children('li').each(function(){a(this).hasClass('tagit-new')?a(this).remove():(a(this).removeClass(['tagit-choice','ui-widget-content','ui-state-default','ui-state-highlight','ui-corner-all','remove','tagit-choice-editable','tagit-choice-read-only'].join(' ')),a(this).text(a(this).children('.tagit-label').text()))}),this.singleFieldNode&&this.singleFieldNode.remove()),this},_createMultipleTags:function(){for(var b=this._splitCleanedInput(),c=0;c<b.length;c++)this.createTag(b[c])},_splitCleanedInput:function(){return this._cleanedInput().split(/[,\s]+/)},_cleanedInput:function(){return a.trim(this.tagInput.val().replace(/^"(.*)"$/,'$1'))},_lastTag:function(){return this.tagList.find('.tagit-choice:last:not(.removed)')},_tags:function(){return this.tagList.find('.tagit-choice:not(.removed)')},readOnly:function(b){this.options.readOnly=b,b?this.tagInput.attr('disabled','disabled'):this.tagInput.removeAttr('disabled');let c=this.assignedTags();this.removeAll();for(var d=0;d<c.length;d++)this.createTag(c[d])},assignedTags:function(){var b=this,c=[];return this.options.singleField?(c=a(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),''===c[0]&&(c=[])):this._tags().each(function(){c.push(b.tagLabel(this))}),c},_updateSingleTagsField:function(b){a(this.options.singleFieldNode).val(b.join(this.options.singleFieldDelimiter)).trigger('change')},_subtractArray:function(b,c){for(var d=[],f=0;f<b.length;f++)-1==a.inArray(b[f],c)&&d.push(b[f]);return d},tagLabel:function(b){return this.options.singleField?a(b).find('.tagit-label:first').text():a(b).find('input:first').val()},_showAutocomplete:function(){this.options.readOnly||this.tagInput.autocomplete('search','')},_findTagByLabel:function(b){var c=this,d=null;return this._tags().each(function(){if(c._formatStr(b)==c._formatStr(c.tagLabel(this)))return d=a(this),!1}),d},_isNew:function(b){return!this._findTagByLabel(b)},_formatStr:function(b){return this.options.caseSensitive?b:a.trim(b.toLowerCase())},_effectExists:function(b){return!!(a.effects&&(a.effects[b]||a.effects.effect&&a.effects.effect[b]))},createTag:function(b,c,d){var f=this;if(b=a.trim(b),this.options.preprocessTag&&(b=this.options.preprocessTag(b)),''===b)return!1;if(!this.options.allowDuplicates&&!this._isNew(b)){var g=this._findTagByLabel(b);return!1!==this._trigger('onTagExists',null,{existingTag:g,duringInitialization:d})&&this._effectExists('highlight')&&g.effect('highlight'),!1}if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit)return this._trigger('onTagLimitExceeded',null,{duringInitialization:d}),!1;var h=a(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(b),j=a('<li></li>').addClass('tagit-choice ui-widget-content ui-state-default ui-corner-all').addClass(c).append(h);if(this.options.readOnly)j.addClass('tagit-choice-read-only');else{j.addClass('tagit-choice-editable');var k=a('<span></span>').addClass('ui-icon ui-icon-close'),l=a('<a><span class="text-icon">\xD7</span></a>').addClass('tagit-close').append(k).click(function(){f.removeTag(j)});j.append(l)}if(!this.options.singleField){var m=h.html();j.append('<input type="hidden" value="'+m+'" name="'+this.options.fieldName+'" class="tagit-hidden-field" />')}if(!1!==this._trigger('beforeTagAdded',null,{tag:j,tagLabel:this.tagLabel(j),duringInitialization:d})){if(this.options.singleField){var n=this.assignedTags();n.push(b),this._updateSingleTagsField(n)}this.tagInput.val(''),this.tagInput.parent().before(j),this._trigger('afterTagAdded',null,{tag:j,tagLabel:this.tagLabel(j),duringInitialization:d}),this.options.showAutocompleteOnFocus&&!d&&setTimeout(function(){f._showAutocomplete()},0)}},removeTag:function(b,c){if(c='undefined'==typeof c?this.options.animate:c,b=a(b),!1!==this._trigger('beforeTagRemoved',null,{tag:b,tagLabel:this.tagLabel(b)})){if(this.options.singleField){var d=this.assignedTags(),f=this.tagLabel(b);d=a.grep(d,function(j){return j!=f}),this._updateSingleTagsField(d)}if(c){b.addClass('removed');var g=this._effectExists('blind')?['blind',{direction:'horizontal'},'fast']:['fast'],h=this;g.push(function(){b.remove(),h._trigger('afterTagRemoved',null,{tag:b,tagLabel:h.tagLabel(b)})}),b.fadeOut('fast').hide.apply(b,g).dequeue()}else b.remove(),this._trigger('afterTagRemoved',null,{tag:b,tagLabel:this.tagLabel(b)})}},removeTagByLabel:function(b,c){var d=this._findTagByLabel(b);if(!d)throw'No such tag exists with the name \''+b+'\'';this.removeTag(d,c)},removeAll:function(){var b=this;this._tags().each(function(c,d){b.removeTag(d,!1)})}})})(jQuery);